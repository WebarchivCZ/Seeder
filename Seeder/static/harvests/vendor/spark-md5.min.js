/* Minimal SparkMD5-compatible ArrayBuffer hasher for chunked uploads. */
(function (global) {
    "use strict";

    var HEX_CHARS = "0123456789abcdef".split("");

    function add32(a, b) {
        return (a + b) | 0;
    }

    function cmn(q, a, b, x, s, t) {
        a = add32(add32(a, q), add32(x, t));
        return add32((a << s) | (a >>> (32 - s)), b);
    }

    function ff(a, b, c, d, x, s, t) {
        return cmn((b & c) | ((~b) & d), a, b, x, s, t);
    }

    function gg(a, b, c, d, x, s, t) {
        return cmn((b & d) | (c & (~d)), a, b, x, s, t);
    }

    function hh(a, b, c, d, x, s, t) {
        return cmn(b ^ c ^ d, a, b, x, s, t);
    }

    function ii(a, b, c, d, x, s, t) {
        return cmn(c ^ (b | (~d)), a, b, x, s, t);
    }

    function md5cycle(state, block) {
        var a = state[0];
        var b = state[1];
        var c = state[2];
        var d = state[3];

        a = ff(a, b, c, d, block[0], 7, -680876936);
        d = ff(d, a, b, c, block[1], 12, -389564586);
        c = ff(c, d, a, b, block[2], 17, 606105819);
        b = ff(b, c, d, a, block[3], 22, -1044525330);
        a = ff(a, b, c, d, block[4], 7, -176418897);
        d = ff(d, a, b, c, block[5], 12, 1200080426);
        c = ff(c, d, a, b, block[6], 17, -1473231341);
        b = ff(b, c, d, a, block[7], 22, -45705983);
        a = ff(a, b, c, d, block[8], 7, 1770035416);
        d = ff(d, a, b, c, block[9], 12, -1958414417);
        c = ff(c, d, a, b, block[10], 17, -42063);
        b = ff(b, c, d, a, block[11], 22, -1990404162);
        a = ff(a, b, c, d, block[12], 7, 1804603682);
        d = ff(d, a, b, c, block[13], 12, -40341101);
        c = ff(c, d, a, b, block[14], 17, -1502002290);
        b = ff(b, c, d, a, block[15], 22, 1236535329);

        a = gg(a, b, c, d, block[1], 5, -165796510);
        d = gg(d, a, b, c, block[6], 9, -1069501632);
        c = gg(c, d, a, b, block[11], 14, 643717713);
        b = gg(b, c, d, a, block[0], 20, -373897302);
        a = gg(a, b, c, d, block[5], 5, -701558691);
        d = gg(d, a, b, c, block[10], 9, 38016083);
        c = gg(c, d, a, b, block[15], 14, -660478335);
        b = gg(b, c, d, a, block[4], 20, -405537848);
        a = gg(a, b, c, d, block[9], 5, 568446438);
        d = gg(d, a, b, c, block[14], 9, -1019803690);
        c = gg(c, d, a, b, block[3], 14, -187363961);
        b = gg(b, c, d, a, block[8], 20, 1163531501);
        a = gg(a, b, c, d, block[13], 5, -1444681467);
        d = gg(d, a, b, c, block[2], 9, -51403784);
        c = gg(c, d, a, b, block[7], 14, 1735328473);
        b = gg(b, c, d, a, block[12], 20, -1926607734);

        a = hh(a, b, c, d, block[5], 4, -378558);
        d = hh(d, a, b, c, block[8], 11, -2022574463);
        c = hh(c, d, a, b, block[11], 16, 1839030562);
        b = hh(b, c, d, a, block[14], 23, -35309556);
        a = hh(a, b, c, d, block[1], 4, -1530992060);
        d = hh(d, a, b, c, block[4], 11, 1272893353);
        c = hh(c, d, a, b, block[7], 16, -155497632);
        b = hh(b, c, d, a, block[10], 23, -1094730640);
        a = hh(a, b, c, d, block[13], 4, 681279174);
        d = hh(d, a, b, c, block[0], 11, -358537222);
        c = hh(c, d, a, b, block[3], 16, -722521979);
        b = hh(b, c, d, a, block[6], 23, 76029189);
        a = hh(a, b, c, d, block[9], 4, -640364487);
        d = hh(d, a, b, c, block[12], 11, -421815835);
        c = hh(c, d, a, b, block[15], 16, 530742520);
        b = hh(b, c, d, a, block[2], 23, -995338651);

        a = ii(a, b, c, d, block[0], 6, -198630844);
        d = ii(d, a, b, c, block[7], 10, 1126891415);
        c = ii(c, d, a, b, block[14], 15, -1416354905);
        b = ii(b, c, d, a, block[5], 21, -57434055);
        a = ii(a, b, c, d, block[12], 6, 1700485571);
        d = ii(d, a, b, c, block[3], 10, -1894986606);
        c = ii(c, d, a, b, block[10], 15, -1051523);
        b = ii(b, c, d, a, block[1], 21, -2054922799);
        a = ii(a, b, c, d, block[8], 6, 1873313359);
        d = ii(d, a, b, c, block[15], 10, -30611744);
        c = ii(c, d, a, b, block[6], 15, -1560198380);
        b = ii(b, c, d, a, block[13], 21, 1309151649);
        a = ii(a, b, c, d, block[4], 6, -145523070);
        d = ii(d, a, b, c, block[11], 10, -1120210379);
        c = ii(c, d, a, b, block[2], 15, 718787259);
        b = ii(b, c, d, a, block[9], 21, -343485551);

        state[0] = add32(state[0], a);
        state[1] = add32(state[1], b);
        state[2] = add32(state[2], c);
        state[3] = add32(state[3], d);
    }

    function blockFromBytes(bytes, offset) {
        var block = new Array(16);
        var i = 0;
        var j = 0;
        for (i = 0; i < 16; i += 1) {
            j = offset + (i * 4);
            block[i] = (
                bytes[j] |
                (bytes[j + 1] << 8) |
                (bytes[j + 2] << 16) |
                (bytes[j + 3] << 24)
            );
        }
        return block;
    }

    function finalizeState(state, tail, totalLength) {
        var finalLength = ((tail.length + 9 + 63) >> 6) << 6;
        var buffer = new Uint8Array(finalLength);
        var bitLength = totalLength * 8;
        var low = bitLength >>> 0;
        var high = Math.floor(bitLength / 0x100000000);
        var i = 0;
        var lengthOffset = 0;

        buffer.set(tail);
        buffer[tail.length] = 0x80;

        lengthOffset = finalLength - 8;
        buffer[lengthOffset] = low & 0xFF;
        buffer[lengthOffset + 1] = (low >>> 8) & 0xFF;
        buffer[lengthOffset + 2] = (low >>> 16) & 0xFF;
        buffer[lengthOffset + 3] = (low >>> 24) & 0xFF;
        buffer[lengthOffset + 4] = high & 0xFF;
        buffer[lengthOffset + 5] = (high >>> 8) & 0xFF;
        buffer[lengthOffset + 6] = (high >>> 16) & 0xFF;
        buffer[lengthOffset + 7] = (high >>> 24) & 0xFF;

        for (i = 0; i < finalLength; i += 64) {
            md5cycle(state, blockFromBytes(buffer, i));
        }
    }

    function rhex(n) {
        var str = "";
        var j = 0;
        for (j = 0; j < 4; j += 1) {
            str += HEX_CHARS[(n >> (j * 8 + 4)) & 0x0F] + HEX_CHARS[(n >> (j * 8)) & 0x0F];
        }
        return str;
    }

    function hex(state) {
        return rhex(state[0]) + rhex(state[1]) + rhex(state[2]) + rhex(state[3]);
    }

    function hexToBinaryString(hexValue) {
        var bytes = "";
        var i = 0;
        for (i = 0; i < hexValue.length; i += 2) {
            bytes += String.fromCharCode(parseInt(hexValue.substr(i, 2), 16));
        }
        return bytes;
    }

    function SparkMD5ArrayBuffer() {
        this.reset();
    }

    SparkMD5ArrayBuffer.prototype.reset = function () {
        this._state = [1732584193, -271733879, -1732584194, 271733878];
        this._tail = new Uint8Array(0);
        this._length = 0;
        return this;
    };

    SparkMD5ArrayBuffer.prototype.append = function (arrayBuffer) {
        var incoming = arrayBuffer instanceof Uint8Array ?
            arrayBuffer :
            new Uint8Array(arrayBuffer);
        var buffer = new Uint8Array(this._tail.length + incoming.length);
        var offset = 0;

        if (incoming.length === 0) {
            return this;
        }

        buffer.set(this._tail, 0);
        buffer.set(incoming, this._tail.length);
        this._length += incoming.length;

        while (offset + 64 <= buffer.length) {
            md5cycle(this._state, blockFromBytes(buffer, offset));
            offset += 64;
        }
        this._tail = buffer.slice(offset);
        return this;
    };

    SparkMD5ArrayBuffer.prototype.end = function (raw) {
        var state = [
            this._state[0],
            this._state[1],
            this._state[2],
            this._state[3]
        ];
        var digest = "";

        finalizeState(state, this._tail, this._length);
        digest = hex(state);
        this.reset();

        return raw ? hexToBinaryString(digest) : digest;
    };

    var SparkMD5 = global.SparkMD5 || {};
    SparkMD5.ArrayBuffer = SparkMD5ArrayBuffer;
    global.SparkMD5 = SparkMD5;
})(this);
